/**
 * AngularJS module to manage HTTP Digest Authentication
 * @version v0.1.0 - 2014-01-10
 * @link https://github.com/mgonto/angular-digest-auth
 * @author Matteo Tafani Alunno <matteo.tafanialunno@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";var dhAuth=angular.module("dgAuth",["angular-md5","ngCookies"]);dhAuth.config(["$httpProvider",function(a){a.interceptors.push(["$rootScope","$q","$authConfig","$authService","$serverAuth",function(a,b,c,d,e){return{request:function(a){return d.processRequest(a),a||b.when(a)},responseError:function(f){if(d.isLoginRequested())return a.$broadcast(c.getEvent("login.error"),f),b.reject(f);if(401===f.status){var g=b.defer(),h={config:f.config,deferred:g};a.requests401.push(h);var i=f.headers(c.getHeader());return e.parseHeader(i),a.$broadcast(c.getEvent("authentication.header"),i),d.restoreCredential()||a.$broadcast(c.getEvent("login.required")),g.promise}return b.reject(f)}}}])}]),dhAuth.run(["$rootScope","$authConfig","$authService","$http",function(a,b,c,d){a.requests401=[];var e=function(){for(var b=0;b<a.requests401.length;b++){var c=a.requests401[b];d(c.config).then(function(a){c.deferred.resolve(a)})}};a.$on("$authRequestSignin",function(a,c){d.post(b.getSign().signin,b.getSign().config).success(c.successful).error(c.error),a.preventDefault()}),a.$on("$authRequestSignout",function(a,c){d.post(b.getSign().signout,b.getSign().config).success(c.successful).error(c.error),a.preventDefault()}),a.$on(b.getEvent("credential.submitted"),e),a.$on(b.getEvent("credential.restored"),e)}]),dhAuth.factory("$clientAuth",["$rootScope","$serverAuth","md5",function(a,b,c){function d(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",d=0,e=function(b){for(var c=[],d=a.length,e=0;b>e;++e)c.push(a[Math.random()*d|0]);return c.join("")},f=function(){d++;for(var a=8-d.toString().length,b="",c=0;a>c;c++)b+="0";return b+d},g=function(a,d,e,f,g,h){var i=c.createHash(a+":"+b.realm+":"+d),j=c.createHash(e+":"+f);return c.createHash(i+":"+b.nonce+":"+g+":"+h+":"+b.qop+":"+j)},h=function(a,c,d,h){var i=f(),j=e(16);return'Digest username="'+a+'", realm="'+b.realm+'", nonce="'+b.nonce+'", uri="'+h+'", algorithm='+b.algorithm+', response="'+g(a,c,d,h,i,j)+'", opaque="'+b.opaque+'", qop='+b.qop+', nc="'+i+'", cnonce="'+j+'"'};this.isConfigured=function(){return b.hasHeader()},this.processRequest=function(a,c,d){d.url.indexOf(b.domain)>=0&&(d.headers.Authorization=h(a,c,d.method,d.url))}}return new d}]),dhAuth.provider("$authConfig",function(){function a(a,b,c){var d=a,e=b,f=c;this.getSign=function(){return d},this.getEvents=function(){return e},this.getEvent=function(a){var b=a.split(".");return e[b[0]][b[1]]},this.getHeader=function(){return f}}var b={signin:"",signout:"",config:""},c={authentication:{header:"$authAuthenticationHeader"},signin:{successful:"$authSigninSuccessful",error:"$authSigninError",required:"$authSigninRequired"},signout:{successful:"$authSignoutSuccessful",error:"$authSignoutError"},credential:{submitted:"$authCredentialSubmitted",stored:"$authCredentialStored",restored:"$authCredentialRestored"}},d="";this.setSign=function(a){angular.extend(b,a)},this.setEvents=function(a){angular.extend(c,a)},this.setHeader=function(a){d=a},this.$get=function(){return new a(b,c,d)}}),dhAuth.factory("$serverAuth",["$authStorage",function(a){function b(){var b=/([a-zA-Z]+)=\"?([a-zA-Z0-9\/\s]+)\"?/,c=!1;this.realm="",this.domain="",this.nonce="",this.opaque="",this.algorithm="",this.qop="",this.hasHeader=function(){return c},this.config=function(a){this.realm=a.realm,this.domain=a.domain,this.nonce=a.nonce,this.opaque=a.opaque,this.algorithm=a.algorithm,this.qop=a.qop,c=!0},this.parseHeader=function(d){for(var e=d.split(", "),f=0;f<e.length;f++){var g=b.exec(e[f]);this[g[1]]=g[2]}c=!0,a.setServerAuth(this)}}var c=function(){var c=new b;return a.hasServerAuth()&&c.config(a.getServerAuth()),c};return c()}]),dhAuth.factory("$authService",["$authConfig","$authStorage","$clientAuth","$rootScope","$cookies","md5",function(a,b,c,d,e,f){function g(){var g,h={username:"",password:"",requested:!1},i=function(){return e._auth==f.createHash("true")&&null!==g},j=function(c){g=c,e._auth=f.createHash("true"),h.requested&&(b.setCredential(h.username,h.password),d.$broadcast(a.getEvents().credential.stored,{username:h.username,password:h.password})),d.$broadcast(a.getEvents().signin.successful,c)},k=function(b,c){h=null,d.$broadcast(a.getEvents().signin.error,b,c)},l=function(b){e._auth=f.createHash("false"),g=null,d.$broadcast(a.getEvents().signout.successful,b)},m=function(b,c){d.$broadcast(a.getEvents().signout.error,b,c)};this.hasIdentity=function(){return null!==g},this.getIdentity=function(){return g},this.setLoginRequest=function(b,c){h={username:b,password:c,requested:!0},d.$broadcast(a.getEvents().loginSubmitted,h)},this.getLoginRequest=function(){return h},this.isLoginRequested=function(){return h.requested},this.isAuthenticated=function(){return i()},this.restoreCredential=function(){return b.hasCredential()&&c.isConfigured()?(h.username=b.getUsername(),h.password=b.getPassword(),d.$broadcast(a.getEvent("credential.restored")),!0):!1},this.processRequest=function(a){c.isConfigured()&&c.processRequest(h.username,h.password,a)},this.signin=function(){d.$broadcast("$authRequestSignin",{successful:j,error:k})},this.signout=function(){d.$broadcast("$authRequestSignout",{successful:l,error:m})}}return new g}]),dhAuth.provider("$authStorage",function(){function a(a){var b=a;this.hasCredential=function(){var a=b.getItem("username"),c=b.getItem("password");return null!==a&&null!==c},this.setCredential=function(a,c){b.setItem("username",a),b.setItem("password",c)},this.hasServerAuth=function(){return null!==sessionStorage.getItem("server")},this.setServerAuth=function(a){sessionStorage.setItem("server",JSON.stringify(a))},this.getServerAuth=function(){return JSON.parse(sessionStorage.getItem("server"))},this.getUsername=function(){return b.getItem("username")},this.getPassword=function(){return b.getItem("password")},this.clear=function(){b.clear()}}var b=sessionStorage;this.setStorage=function(a){b=a},this.$get=function(){return new a(b)}});